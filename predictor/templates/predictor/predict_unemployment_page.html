{% extends "base.html" %}
{% block title %}
D·ª± ƒëo√°n th·∫•t nghi·ªáp
{% endblock %}
{% block content %}
<div class="card w-full max-w-xl mx-auto my-10 bg-base-100 shadow-xl p-6 md:p-10">
    <div class="card-body p-0">
        <h1 class="text-3xl font-bold text-center text-primary mb-2">
            üìä D·ª± ƒëo√°n R·ªßi ro Th·∫•t nghi·ªáp
        </h1>
        <p class="text-center text-base-content/80 mb-6">
            Nh·∫≠p th√¥ng tin nh√¢n kh·∫©u h·ªçc ƒë·ªÉ d·ª± ƒëo√°n r·ªßi ro th·∫•t nghi·ªáp.
        </p>
    </div>
    <div class="space-y-8">
        <a href="{% url 'predict' %}"
            class="inline-block mb-6 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-lg hover:bg-purple-700 transition-all"
            style="box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            <i class="fas fa-user-times"></i>
            Chuy·ªÉn ƒë·∫øn D·ª± ƒëo√°n Thu nh·∫≠p
        </a>
    </div>
    <form id="unemployment-form" class="space-y-4">

        <label class="form-control w-full">
            <div class="label"><span class="label-text">Tu·ªïi (Age):</span></div>
            <input type="number" id="age" name="age" value="30" required class="input input-bordered w-full"
                placeholder="V√≠ d·ª•: 30" />
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">S·ªë nƒÉm H·ªçc v·∫•n (Education-num):</span></div>
            <input type="number" id="education-num" name="education-num" value="13" required
                class="input input-bordered w-full" placeholder="V√≠ d·ª•: 13 (C·ª≠ nh√¢n)" />
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">T√¨nh tr·∫°ng H√¥n nh√¢n (Marital-status):</span></div>
            <select id="marital-status" name="marital-status" class="select select-bordered w-full">
                <option value="?">Kh√¥ng r√µ</option>
                <option value="Married-civ-spouse">ƒê√£ k·∫øt h√¥n (v·ª£/ch·ªìng d√¢n s·ª±)</option>
                <option value="Never-married">Ch∆∞a k·∫øt h√¥n</option>
                <option value="Divorced">ƒê√£ ly h√¥n</option>
                <option value="Separated">Ly th√¢n</option>
                <option value="Widowed">G√≥a</option>
                <option value="Married-spouse-absent">ƒê√£ k·∫øt h√¥n (v·∫Øng m·∫∑t)</option>
                <option value="Married-AF-spouse">ƒê√£ k·∫øt h√¥n (Qu√¢n ƒë·ªôi)</option>
            </select>
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">Ngh·ªÅ nghi·ªáp (Occupation):</span></div>
            <select id="occupation" name="occupation" class="select select-bordered w-full">
                <option value="?">Kh√¥ng r√µ / Ch∆∞a c√≥</option>
                <option value="Tech-support">H·ªó tr·ª£ K·ªπ thu·∫≠t</option>
                <option value="Craft-repair">S·ª≠a ch·ªØa</option>
                <option value="Other-service">D·ªãch v·ª• kh√°c</option>
                <option value="Sales">B√°n h√†ng</option>
                <option value="Exec-managerial">Qu·∫£n l√Ω/ƒêi·ªÅu h√†nh</option>
                <option value="Prof-specialty">Chuy√™n m√¥n</option>
                <option value="Handlers-cleaners">Lao c√¥ng/B·ªëc v√°c</option>
                <option value="Machine-op-inspct">V·∫≠n h√†nh m√°y m√≥c</option>
                <option value="Adm-clerical">H√†nh ch√≠nh vƒÉn ph√≤ng</option>
                <option value="Farming-fishing">N√¥ng nghi·ªáp/Ng∆∞ nghi·ªáp</option>
                <option value="Transport-moving">V·∫≠n t·∫£i</option>
                <option value="Priv-house-serv">Gi√∫p vi·ªác</option>
                <option value="Protective-serv">B·∫£o v·ªá</option>
                <option value="Armed-Forces">Qu√¢n ƒë·ªôi</option>
            </select>
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">M·ªëi quan h·ªá trong gia ƒë√¨nh (Relationship):</span></div>
            <select id="relationship" name="relationship" class="select select-bordered w-full">
                <option value="?">Kh√¥ng r√µ</option>
                <option value="Wife">V·ª£</option>
                <option value="Own-child">Con ru·ªôt</option>
                <option value="Husband">Ch·ªìng</option>
                <option value="Not-in-family">Kh√¥ng ph·∫£i th√†nh vi√™n gia ƒë√¨nh</option>
                <option value="Other-relative">H·ªç h√†ng kh√°c</option>
                <option value="Unmarried">Ch∆∞a k·∫øt h√¥n (s·ªëng chung)</option>
            </select>
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">Ch·ªßng t·ªôc (Race):</span></div>
            <select id="race" name="race" class="select select-bordered w-full">
                <option value="?">Kh√¥ng r√µ</option>
                <option value="White">Da tr·∫Øng</option>
                <option value="Asian-Pac-Islander">Ch√¢u √Å/ƒê·∫£o Th√°i B√¨nh D∆∞∆°ng</option>
                <option value="Amer-Indian-Eskimo">Ng∆∞·ªùi M·ªπ b·∫£n ƒë·ªãa/Eskimo</option>
                <option value="Other">Kh√°c</option>
                <option value="Black">Da ƒëen</option>
            </select>
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">Gi·ªõi t√≠nh (Sex):</span></div>
            <select id="sex" name="sex" class="select select-bordered w-full">
                <option value="?">Kh√¥ng r√µ</option>
                <option value="Female">N·ªØ</option>
                <option value="Male">Nam</option>
            </select>
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">S·ªë gi·ªù l√†m m·ªói tu·∫ßn (Hours-per-week):</span></div>
            <input type="number" id="hours-per-week" name="hours-per-week" value="40" required
                class="input input-bordered w-full" placeholder="V√≠ d·ª•: 40" />
        </label>

        <label class="form-control w-full">
            <div class="label"><span class="label-text">Qu·ªëc gia b·∫£n x·ª© (Native Country):</span></div>
            <select id="native-country" name="native-country" class="select select-bordered w-full">
                <option value="?">Kh√¥ng r√µ</option>
                <option value="United-States">Hoa K·ª≥</option>
                <option value="Mexico">Mexico</option>
                <option value="Philippines">Philippines</option>
                <option value="Germany">ƒê·ª©c</option>
                <option value="Canada">Canada</option>
                <option value="Puerto-Rico">Puerto-Rico</option>
                <option value="El-Salvador">El-Salvador</option>
                <option value="India">·∫§n ƒê·ªô</option>
                <option value="Cuba">Cuba</option>
                <option value="England">Anh</option>
                <option value="Jamaica">Jamaica</option>
                <option value="South">Nam H√†n (South)</option>
                <option value="China">Trung Qu·ªëc</option>
                <option value="Italy">√ù</option>
                <option value="Dominican-Republic">C·ªông h√≤a Dominica</option>
                <option value="Vietnam">Vi·ªát Nam</option>
                <option value="Guatemala">Guatemala</option>
                <option value="Japan">Nh·∫≠t B·∫£n</option>
                <option value="Poland">Ba Lan</option>
                <option value="Columbia">Columbia</option>
                <option value="Taiwan">ƒê√†i Loan</option>
                <option value="Haiti">Haiti</option>
                <option value="Iran">Iran</option>
                <option value="Portugal">B·ªì ƒê√†o Nha</option>
                <option value="Nicaragua">Nicaragua</option>
                <option value="Peru">Peru</option>
                <option value="France">Ph√°p</option>
                <option value="Greece">Hy L·∫°p</option>
                <option value="Ecuador">Ecuador</option>
                <option value="Ireland">Ireland</option>
                <option value="Hong">H·ªìng K√¥ng</option>
                <option value="Cambodia">Campuchia</option>
                <option value="Trinadad&Tobago">Trinadad & Tobago</option>
                <option value="Thailand">Th√°i Lan</option>
                <option value="Laos">L√†o</option>
                <option value="Yugoslavia">Nam T∆∞</option>
                <option value="Outlying-US(Guam-USVI-etc)">L√£nh th·ªï h·∫£i ngo·∫°i Hoa K·ª≥</option>
                <option value="Honduras">Honduras</option>
                <option value="Hungary">Hungary</option>
                <option value="Scotland">Scotland</option>
                <option value="Holand-Netherlands">H√† Lan</option>
            </select>
        </label>

        <button type="submit" class="btn btn-primary w-full mt-6">
            D·ª± ƒëo√°n R·ªßi ro Th·∫•t nghi·ªáp
        </button>
    </form>

    <div id="result-container" class="mt-8 pt-4 border-t border-base-200 text-center">
        <h2 class="text-xl font-semibold mb-4">K·∫øt qu·∫£ D·ª± ƒëo√°n:</h2>
        <div class="flex flex-col items-center space-y-4">
            <div id="gauge-chart" class="radial-progress text-primary"
                style="--value:0; --size:6rem; --thickness: 0.8rem;">
                <span id="gauge-text" class="text-2xl font-bold">0%</span>
            </div>
            <p id="result" class="text-lg font-medium max-w-md">---</p>
        </div>
    </div>
</div>
</div>

<script>
    // H√†m JavaScript ƒë·ªÉ c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì Gauge
    function updateGauge(probability) {
        const gauge = document.getElementById('gauge-chart');
        const gaugeText = document.getElementById('gauge-text');

        gauge.style.setProperty('--value', probability);
        gaugeText.innerText = `${probability}%`;

        // T√πy ch·ªânh m√†u theo r·ªßi ro (v√≠ d·ª•: > 50% l√† r·ªßi ro cao)
        if (probability >= 50) {
            gauge.classList.add('text-error');
            gauge.classList.remove('text-warning', 'text-success');
        } else if (probability >= 20) {
            gauge.classList.add('text-warning');
            gauge.classList.remove('text-success', 'text-error');
        } else {
            gauge.classList.add('text-success'); // R·ªßi ro th·∫•p
            gauge.classList.remove('text-warning', 'text-error');
        }
    }

    // B·∫Øt s·ª± ki·ªán form submit
    document.getElementById('unemployment-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const resultEl = document.getElementById('result');
        const loadingEl = document.getElementById('loading'); // Gi·∫£ s·ª≠ b·∫°n c√≥ 1 spinner

        // 1. Thu th·∫≠p d·ªØ li·ªáu t·ª´ form
        const data = {
            'age': parseInt(document.getElementById('age').value),
            'education-num': parseInt(document.getElementById('education-num').value),
            'marital-status': document.getElementById('marital-status').value,
            'occupation': document.getElementById('occupation').value,
            'relationship': document.getElementById('relationship').value,
            'race': document.getElementById('race').value,
            'sex': document.getElementById('sex').value,
            'hours-per-week': parseInt(document.getElementById('hours-per-week').value),
            'native-country': document.getElementById('native-country').value,
            // G·ª≠i capital-gain/loss = 0
            'capital-gain': 0,
            'capital-loss': 0,
        };

        console.log("D·ªØ li·ªáu g·ª≠i ƒëi:", data); // Ki·ªÉm tra d·ªØ li·ªáu

        // 2. G·ª≠i d·ªØ li·ªáu ƒë·∫øn API TH·∫§T NGHI·ªÜP
        fetch('/app/api/predict_unemployment/', { // <-- S·ª¨ D·ª§NG URL M·ªöI
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // (B·∫°n c·∫ßn CSRF token n·∫øu kh√¥ng d√πng @csrf_exempt)
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.prediction) {
                    // C·∫≠p nh·∫≠t vƒÉn b·∫£n
                    resultEl.innerHTML = `D·ª± ƒëo√°n: <strong>${data.prediction}</strong> (v·ªõi x√°c su·∫•t <strong>${data.probability}%</strong>).`;
                    // C·∫≠p nh·∫≠t ƒê·ªìng h·ªì ƒëo
                    updateGauge(data.probability);
                } else {
                    resultEl.innerText = `L·ªói: ${data.error}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultEl.innerText = 'ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi server.';
            });
    });
</script>
{% endblock %}